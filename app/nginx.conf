server {
    listen 80;
    server_name localhost; # Або ваш домен

    # Шлях до зібраного фронтенду всередині контейнера
    root /usr/share/nginx/html;
    index index.html index.htm;

    # Забезпечує роботу React Router (віддає index.html для будь-якого шляху, що не є файлом)
    location / {
        try_files $uri $uri/ /index.html;
    }

    # Проксі для API запитів до вашого бекенду
    # Перехоплює запити, що починаються з /backend-api/
    # і перенаправляє їх на сервіс 'backend' на порт 3001, додаючи /api/ в кінець
    location /backend-api/ {
        # backend - ім'я сервісу в docker-compose.yml
        # 3001 - порт, який слухає ваш server.js
        # /api/ - додаємо шлях, який очікує ваш бекенд (згідно server.js і vite proxy)
        proxy_pass http://backend:3001/api/;

        # Важливі заголовки для коректної роботи проксі
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_read_timeout 86400; # Збільшуємо таймаут, якщо API запити довгі
    }

    # Проксі для API запитів до Ollama
    # Перехоплює запити, що починаються з /ollama-api/
    # і перенаправляє їх на сервіс 'ollama' на порт 11434, додаючи /api/ в кінець
    location /ollama-api/ {
        # ollama - ім'я сервісу в docker-compose.yml
        # 11434 - стандартний порт Ollama
        # /api/ - додаємо шлях, який очікує Ollama API (згідно vite proxy)
        proxy_pass http://ollama:11434/api/;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_read_timeout 86400; # Ollama може відповідати довго
    }

    # (Опціонально) Додаткові налаштування для кешування статики
    location ~* \.(?:css|js|jpg|jpeg|gif|png|ico|svg|woff|woff2|ttf|eot|webmanifest)$ {
        expires 1y;
        add_header Cache-Control "public";
        access_log off; # Не логувати запити до статики
    }
}